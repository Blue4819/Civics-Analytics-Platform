{% extends 'base.html' %}

{% block content %}
<h1>Dashboard</h1>
<div id="dashboard" class="dashboard-container">
    <div class="card">
        <h3>National Disasters</h3>
        <canvas id="miniDisasterChart"></canvas>
    </div>
    <div class="card">
        <h3>COVID-19 Cases by State</h3>
        <canvas id="miniCovidChart"></canvas>
    </div>
    <div class="card">
        <h3>Fiscal Deficits by State</h3>
        <canvas id="miniFiscalDeficitChart"></canvas>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dashboard = document.getElementById('dashboard');
        Sortable.create(dashboard, {
            animation: 150, // Animation speed in milliseconds
            ghostClass: 'sortable-ghost', // Class name for the ghost element
            chosenClass: 'sortable-chosen', // Class name for the chosen item
            dragClass: 'sortable-drag' // Class name for the dragging item
        });

        const fetchDataAndRenderCharts = async () => {
            // Fetch disaster data
            const disasterResponse = await fetch('/nationaldisasters'); // Fetch the page to get the data
            const disasterData = await disasterResponse.text();
            const disasterChartData = extractDisasterData(disasterData);
            renderMiniChart('miniDisasterChart', disasterChartData.labels, disasterChartData.counts);

            // Fetch COVID data
            const covidResponse = await fetch('/nationaldisasters'); // Fetch the same page to get the data
            const covidData = await covidResponse.text();
            const covidChartData = extractCovidData(covidData);
            renderMiniChart('miniCovidChart', covidChartData.labels, covidChartData.counts);

            // Fetch fiscal deficit data
            const fiscalResponse = await fetch('/economicdeficits'); // Fetch the page to get the data
            const fiscalData = await fiscalResponse.text();
            const fiscalChartData = extractFiscalData(fiscalData);
            renderMiniChart('miniFiscalDeficitChart', fiscalChartData.labels, fiscalChartData.values);
        };

        const extractDisasterData = (html) => {
            // Logic to extract disaster data from the HTML
            const disasterData = JSON.parse(html.match(/const disasterData = (.*?);/)[1]);
            return {
                labels: Object.keys(disasterData),
                counts: Object.values(disasterData)
            };
        };

        const extractCovidData = (html) => {
            // Logic to extract COVID data from the HTML
            const covidData = JSON.parse(html.match(/const covidData = (.*?);/)[1]);
            const stateCases = {};
            covidData.forEach(entry => {
                const state = entry['Name of State / UT'];
                const cases = entry['Total Confirmed cases'] || 0;
                stateCases[state] = (stateCases[state] || 0) + cases;
            });
            return {
                labels: Object.keys(stateCases),
                counts: Object.values(stateCases)
            };
        };

        const extractFiscalData = (html) => {
            // Logic to extract fiscal data from the HTML
            const fiscalData = JSON.parse(html.match(/const fiscalData = (.*?);/)[1]);
            return {
                labels: Object.keys(fiscalData[0]).filter(key => key !== 'State'),
                values: fiscalData.map(state => Object.values(state).slice(1)) // Exclude 'State' key
            };
        };

        const renderMiniChart = (canvasId, labels, data) => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Data',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        };

        fetchDataAndRenderCharts();
    });
</script>

<style>
    .dashboard-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    .card {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        height: 300px;
        width: 400px;
        padding: 5px;
        text-align: center;
    }
</style>
{% endblock %}